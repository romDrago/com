<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Post Details</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            max-width: 100vw;
            background-color: #111;
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #postContent {
            color: #ccc;
            margin-bottom: 20px;
            font-size: 1.25em;
        }

        h1 {
            margin-bottom: 10px;
        }

        .toggle-buttons {
            margin-bottom: 20px;
        }

        .toggle-buttons button {
            margin-right: 10px;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            background-color: #222;
            color: #0af;
            cursor: pointer;
        }

        .toggle-buttons button.active {
            background-color: #0af;
            color: #111;
        }

        .media-section {
            display: none;
        }

        .media-section.active {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
            justify-content: center;
            align-items: center;
        }

        .media-section img,
        video {
            width: 300px;
            border-radius: 10px;
            object-fit: cover;
            cursor: pointer;
        }

        .video-placeholder {
            width: 300px;
            height: 200px;
            border-radius: 10px;
            background-color: #222;
            color: #0af;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: bold;
            position: relative;
        }

        /* Lightbox */
        .lightbox {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 999;
        }

        .lightbox img {
            max-width: 90%;
            max-height: 90%;
        }
    </style>
</head>

<body>

    <div class="toggle-buttons">
        <button id="toggleImages" class="active">Images</button>
        <button id="toggleVideos">Videos</button>
    </div>
    <h1 id="postTitle">Post</h1>
    <p id="postContent"></p>

    <div id="imageSection" class="media-section active"></div>
    <div id="videoSection" class="media-section"></div>

    <div id="lightbox" class="lightbox" style="display: none;">
        <img id="lightboxImg" src="" alt="">
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const creatorId = params.get("id");
        const service = params.get("service");
        const postId = params.get("post_id");

        const postTitle = document.getElementById("postTitle");
        const postContent = document.getElementById("postContent");
        const imageSection = document.getElementById("imageSection");
        const videoSection = document.getElementById("videoSection");
        const lightbox = document.getElementById("lightbox");
        const lightboxImg = document.getElementById("lightboxImg");

        let imageUrls = [];
        let currentImageIndex = 0;

        document.getElementById("toggleImages").onclick = () => {
            imageSection.classList.add("active");
            videoSection.classList.remove("active");
            setActiveButton("toggleImages");
        };

        document.getElementById("toggleVideos").onclick = () => {
            videoSection.classList.add("active");
            imageSection.classList.remove("active");
            setActiveButton("toggleVideos");
        };

        function setActiveButton(id) {
            document.querySelectorAll('.toggle-buttons button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(id).classList.add('active');
        }

        async function loadPost() {
            try {
                const res = await fetch(`http://127.0.0.1:5000/api/post_detail?service=${service}&id=${creatorId}&post_id=${postId}`);
                const data = await res.json();

                postTitle.textContent = data.title || "Post";
                postContent.textContent = data.post.content || "";

                const imgAttachments = data.post.attachments || [];
                imgAttachments.forEach((att, idx) => {
                    const ext = att.path.split('.').pop().toLowerCase();
                    if (["jpg", "jpeg", "png", "gif", "webp"].includes(ext)) {
                        const url = `https://img.coomer.su/thumbnail/data${att.path}`;
                        const img = document.createElement("img");
                        img.src = url;
                        img.alt = `Image ${idx + 1}`;
                        img.dataset.index = imageUrls.length;
                        img.addEventListener("click", () => openLightbox(parseInt(img.dataset.index)));
                        imageSection.appendChild(img);
                        imageUrls.push(url);
                    }
                });

                const videoAttachments = data.attachments || [];
                videoAttachments.forEach(att => {
                    const ext = att.extension.toLowerCase();
                    if ([".mp4", ".webm", ".mov", ".mkv"].includes(ext)) {
                        const placeholder = document.createElement("div");
                        placeholder.className = "video-placeholder";
                        placeholder.textContent = "â–¶ Click to Load Video";
                        placeholder.setAttribute("data-src", `${att.server}/data${att.path}`);

                        placeholder.addEventListener("click", function () {
                            const video = document.createElement("video");
                            video.src = this.getAttribute("data-src");
                            video.controls = true;
                            video.autoplay = true;
                            this.replaceWith(video);
                        });

                        videoSection.appendChild(placeholder);
                    }
                });

            } catch (err) {
                postTitle.textContent = "Failed to load post";
                console.error(err);
            }
        }

        function openLightbox(index) {
            currentImageIndex = index;
            lightboxImg.src = imageUrls[currentImageIndex];
            lightbox.style.display = "flex";
        }

        function closeLightbox() {
            lightbox.style.display = "none";
        }

        function showNextImage() {
            currentImageIndex = (currentImageIndex + 1) % imageUrls.length;
            lightboxImg.src = imageUrls[currentImageIndex];
        }

        function showPrevImage() {
            currentImageIndex = (currentImageIndex - 1 + imageUrls.length) % imageUrls.length;
            lightboxImg.src = imageUrls[currentImageIndex];
        }

        lightbox.addEventListener("click", closeLightbox);

        document.addEventListener("keydown", (e) => {
            if (lightbox.style.display !== "flex") return;
            if (e.key === "ArrowRight") showNextImage();
            if (e.key === "ArrowLeft") showPrevImage();
            if (e.key === "Escape") closeLightbox();
        });

        document.addEventListener("wheel", (e) => {
            if (lightbox.style.display !== "flex") return;
            if (e.deltaY > 0) showNextImage();
            else showPrevImage();
        });

        loadPost();
    </script>
</body>

</html>